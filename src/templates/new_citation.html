{% extends "layout.html" %}

{% block title %}
Create a new citation
{% endblock %}

{% block body %}

<h1 class="mb-3">Create a new citation</h2>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul style="color: red;">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<form id="doi-form">
  <div class="row g-2 mb-2">
    <div class="col-md-6">
      <input id="doi" type="text" name="doi" class="form-control form-control-sm" maxlength="100" placeholder="DOI">
    
      <button id="doi_button" class="btn btn-primary btn-sm" type="submit">
        Fill with DOI
      </button>
    </div>
  </div>
</form>

<form action="/create_citation" method="post">
  <div class="row g-2 mb-2">
    <div class="col-md-3">
      <select id="type" name="type" class="form-select form-select-sm" required>
        {% for citation_type in citation_types %}
          <option value="{{ citation_type }}">{{ citation_type|capitalize }}</option>
        {% endfor %}
      </select>
    </div>
  <div class="col-md-9">
      <input id="title" type="text" name="title" class="form-control form-control-sm" maxlength="200" placeholder="Title" required>
    </div>
  </div>

  <div class="row g-2 mb-2">
    <div class="col-md-8">
      <input id="author" type="text" name="author" class="form-control form-control-sm" maxlength="100" placeholder="Author" required>
    </div>
    <div class="col-md-4">
      <input id="date" type="text" name="date" class="form-control form-control-sm" maxlength="4" placeholder="Year" required>
    </div>
  </div>

  <div class="row g-2 mb-2">
    <div class="col-md-4">
      <input id="journal" type="text" name="journal" class="form-control form-control-sm" maxlength="100" placeholder="Journal">
    </div>
    <div class="col-md-4">
      <input id="booktitle" type="text" name="booktitle" class="form-control form-control-sm" maxlength="100" placeholder="Booktitle">
    </div>
    <div class="col-md-4">
      <input id="publisher" type="text" name="publisher" class="form-control form-control-sm" maxlength="100" placeholder="Publisher">
    </div>
    <div class="col-md-4">
      <input id="institution" type="text" name="institution" class="form-control form-control-sm" maxlength="100" placeholder="Institution">
    </div>
    <div class="col-md-4">
      <input id="editor" type="text" name="editor" class="form-control form-control-sm" maxlength="100" placeholder="Editor">
    </div>
    <div class="col-md-2">
      <input id="volume" type="text" name="volume" class="form-control form-control-sm" maxlength="20" placeholder="Volume">
    </div>
    <div class="col-md-2">
      <input id="number" type="text" name="number" class="form-control form-control-sm" maxlength="20" placeholder="Number">
    </div>
    <div class="col-md-2">
      <input id="pages" type="text" name="pages" class="form-control form-control-sm" maxlength="20" placeholder="Pages">
    </div>
    <div class="col-md-2">
      <input id="edition" type="text" name="edition" class="form-control form-control-sm" maxlength="20" placeholder="Edition">
    </div>
    <div class="col-md-12">
      <input id="note" type="text" name="note" class="form-control form-control-sm" maxlength="200" placeholder="Note">
    </div>
  </div>
  
  <div id="error_message" style="color: red; margin-top: 8px;"></div>
  <br>
  <div class="d-flex justify-content-between mt-2">
    <a id="back-btn" href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">Back</a>
    <button id="submit_button" class="btn btn-primary btn-sm" type="submit" disabled>
      Add citation
    </button>
  </div>
</form>

<script>
  const title = document.getElementById("title");
  const author = document.getElementById("author");
  const date = document.getElementById("date");
  const journal = document.getElementById("journal");
  const booktitle = document.getElementById("booktitle");
  const publisher = document.getElementById("publisher");
  const volume = document.getElementById("volume");
  const number = document.getElementById("number");
  const pages = document.getElementById("pages");
  const editor = document.getElementById("editor");
  const edition = document.getElementById("edition");
  const institution = document.getElementById("institution");
  const note = document.getElementById("note");
  const button = document.getElementById("submit_button");
  const errorbox = document.getElementById("error_message")
  const typeSelect = document.getElementById("type");
  const doi = document.getElementById("doi");

  const allFields = [
    'journal', 'booktitle', 'publisher', 'institution', 'editor', 
    'volume', 'number', 'pages', 'edition', 'note'
  ];

  const fields = {
    article: ['publisher', 'journal', 'volume', 'number', 'pages', 'note'],
    book: ['publisher', 'editor', 'edition', 'volume', 'number', 'pages', 'note'],
    misc: allFields
  }

  function updateFields() {
    const type = typeSelect.value;
    const visibleFields = fields[type] || [];
    
    allFields.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        const container = element.parentElement;
        if (visibleFields.includes(id)) {
          container.style.display = "";
        } else {
          container.style.display = "none";
        }
      }
    });
  }

  typeSelect.addEventListener("change", updateFields);
  updateFields();

  function validate() {
    const t = title.value.trim();
    const a = author.value.trim();
    const d = date.value.trim();

    errorbox.textContent = ""
    button.disabled = true;

    if (!t || !a || !d) {
      errorbox.textContent = "Citation fields cannot be empty";
      return;
    }

    const num = Number(d);
    const currentYear = new Date().getFullYear()
    if (isNaN(num) || num < 1 || num > currentYear || String(d).startsWith("0")) {
      errorbox.textContent = `Year must be between 1 and ${currentYear}!`;
      return;
    }

    button.disabled = false;
  }

  title.addEventListener("input", validate);
  author.addEventListener("input", validate);
  date.addEventListener("input", validate);

  validate();

  const doiForm = document.getElementById("doi-form");
  const doiButton = document.getElementById("doi_button");
  
  doiForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const doiValue = doi.value.trim();
    if (!doiValue) {
      errorbox.textContent = "Please enter a DOI";
      return;
    }
    
    doiButton.disabled = true;
    doiButton.textContent = "Loading...";
    errorbox.textContent = "";
    
    try {
      const formData = new FormData();
      formData.append("doi", doiValue);
      
      const response = await fetch("/fill_with_doi", {
        method: "POST",
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        title.value = data.title || "";
        author.value = data.author || "";
        date.value = data.year || "";
        
        if (data.type && ['article', 'book', 'misc'].includes(data.type)) {
          typeSelect.value = data.type;
          updateFields();
        }
        
        journal.value = data.journal || "";
        booktitle.value = data.booktitle || "";
        publisher.value = data.publisher || "";
        volume.value = data.volume || "";
        number.value = data.number || "";
        pages.value = data.pages || "";
        institution.value = data.institution || "";
        
        doi.value = "";
        
        validate();
        
        errorbox.style.color = "green";
        errorbox.textContent = "DOI data loaded successfully!";
        setTimeout(() => {
          errorbox.textContent = "";
          errorbox.style.color = "red";
        }, 3000);
      } else {
        errorbox.textContent = data.error || "Failed to fetch DOI data";
      }
    } catch (error) {
      errorbox.textContent = "Error fetching DOI data: " + error.message;
    } finally {
      doiButton.disabled = false;
      doiButton.textContent = "Fill with DOI";
    }
  });
</script>
{% endblock %}
