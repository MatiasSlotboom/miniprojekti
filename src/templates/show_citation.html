{% extends "layout.html" %}

{% block title %}
Show citation
{% endblock %}

{% block body %}

<h1 class="mb-3">Citation app</h1>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul style="color: red;">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<div class="card">
  <div class="card-header">
    <h4 class="mb-0">Details</h4>
  </div>

  <ul class="list-group list-group-flush">
    <li class="list-group-item"><strong>Title:</strong> {{ citation.title }}</li>
    <li class="list-group-item"><strong>Type:</strong> {{ citation.type }}</li>
    <li class="list-group-item"><strong>Author:</strong> {{ citation.author }}</li>
    <li class="list-group-item"><strong>Year:</strong> {{ citation.date }}</li>
  </ul>
</div>

<div class="mt-3 d-flex gap-2">
  <a href="{{ url_for('index') }}" class="btn btn-secondary">Back</a>
    <form action="{{ url_for('remove_citation', citation_id=citation.id) }}"
        method="POST"
        onsubmit="return confirm('Are you sure you want to delete this citation?');">
    <button type="submit" class="btn btn-danger">Delete</button>
  </form>
  <form action="{{ url_for('edit_citation', citation_id=citation.id) }}" method="get">
    <button type="submit" class="btn btn-primary ms-2">Edit</button>
  </form>
  <button id="copy_bib_button" type="button" class="btn btn-primary ms-2" onclick="copyBibtex()">
    Copy to clipboard
  </button>
</div>


<div id="copy-alert" class="mt-3"></div>

<script>
  async function copyBibtex() {
    try {
      const response = await fetch("/copy_bib_citation/{{ citation.id }}");
      if (!response.ok) {
        showCopyAlert("Failed to fetch BibTex content.");
        return;
      }

      const text = await response.text();
      await navigator.clipboard.writeText(text);

      showCopyAlert("Bibtex copied to clipboard");      
    } catch (err) {
      console.error(err);
      showCopyAlert("Copy to clipboard failed, browser stuff")
    }
  }

  function showCopyAlert(message) {
    const alertDiv = document.getElementById("copy-alert");
    alertDiv.innerHTML = `
      <div class="alert alert-primary" role="alert">
        ${message}
      </div>
    `;

    setTimeout(() => {
      alertDiv.innerHTML = "";
    }, 3000);
  }
</script>
{% endblock %}
